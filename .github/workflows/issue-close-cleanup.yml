name: Clean Up Labels on Issue Close

on:
  issues:
    types: [closed]

permissions:
  issues: write

jobs:
  cleanup-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Update Labels Based on Close Reason
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const stateReason = issue.state_reason;

            console.log('Issue #' + issue.number + ' closed with reason: ' + stateReason);

            // Remove status labels
            const labelsToRemove = ['status: in-progress', 'status: available', 'status: blocked'];

            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  owner, repo,
                  issue_number: issue.number,
                  name: label
                });
                console.log('Removed label: ' + label);
              } catch (e) {
                // Label doesn't exist, that's fine
              }
            }

            // Add appropriate label based on close reason
            let newLabel = '';
            let commentBody = '';

            if (stateReason === 'completed') {
              newLabel = 'status: completed';
              commentBody = '‚úÖ This issue has been **completed** and closed.';
            } else if (stateReason === 'not_planned') {
              newLabel = 'status: not-planned';
              commentBody = 'üö´ This issue was closed as **not planned**.';
            } else if (stateReason === 'duplicate') {
              newLabel = 'duplicate';
              commentBody = 'üîÑ This issue was closed as a **duplicate**.';
            } else {
              // Default case (closed without specific reason)
              newLabel = 'status: closed';
              commentBody = 'üìù This issue has been closed.';
            }

            // Add the new label
            try {
              await github.rest.issues.addLabels({
                owner, repo,
                issue_number: issue.number,
                labels: [newLabel]
              });
              console.log('Added label: ' + newLabel);
            } catch (e) {
              console.log('Could not add label: ' + newLabel);
            }

            // Add a comment explaining the close
            await github.rest.issues.createComment({
              owner, repo,
              issue_number: issue.number,
              body: commentBody + '\n\n_Labels have been automatically updated._'
            });
