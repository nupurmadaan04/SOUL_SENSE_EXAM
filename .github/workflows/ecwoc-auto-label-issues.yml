name: Apply ECWoC Label to All Issues

on:
  issues:
    types:
      - opened
      - closed

  # Manual trigger to label ALL previous issues
  workflow_dispatch:

permissions:
  issues: write

jobs:
  label-issues:
    runs-on: ubuntu-latest

    steps:
      - name: Add ECWoC label
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const labelName = "ECWoC";

            // Function to label a single issue
            async function labelIssue(issue) {
              const labels = issue.labels.map(l => l.name);
              if (!labels.includes(labelName)) {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issue.number,
                  labels: [labelName],
                });
                console.log(`‚úÖ Labeled issue #${issue.number}`);
              } else {
                console.log(`‚ÑπÔ∏è Issue #${issue.number} already labeled`);
              }
            }

            // If triggered by issue event (opened/closed)
            if (context.eventName === "issues") {
              await labelIssue(context.payload.issue);
              return;
            }

            // If triggered manually ‚Üí label ALL issues (open + closed)
            let page = 1;
            const per_page = 100;

            while (true) {
              const { data: issues } = await github.rest.issues.listForRepo({
                owner,
                repo,
                state: "all",
                per_page,
                page,
              });

              if (issues.length === 0) break;

              for (const issue of issues) {
                // Skip PRs
                if (!issue.pull_request) {
                  await labelIssue(issue);
                }
              }

              page++;
            }

            console.log("üéâ Finished labeling all issues");
